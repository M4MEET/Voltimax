{% sw_extends "@Storefront/storefront/component/product/card/price-unit.html.twig" %}

{#
    Voltimax Theme v3.0.0 - Enhanced Price Unit Template
    Based on proven v2.2.3 structure with v3.0.0 enhancements
    
    Features:
    - Prominent pricing display (fs-1 fw-bold for main price)
    - Tax information with modal link integration
    - Delivery information with status indicators
    - Stock information badges (success/warning/danger)
    - Complete price logic preservation from original
#}

{% block component_product_box_price_info %}
    {% set cheapest = product.calculatedCheapestPrice %}
    {% set real = product.calculatedPrice %}
    {% if product.calculatedPrices.count > 0 %}
        {% set real = product.calculatedPrices.last %}
    {% endif %}

    {% set referencePrice = real.referencePrice %}
    {% set displayFrom = product.calculatedPrices.count > 1 %}
    {% set displayParent = product.variantListingConfig.displayParent and product.parentId === null %}

    {% if displayParent %}
        {% set displayFromVariants = displayParent and real.unitPrice !== cheapest.unitPrice %}
        {% set real = cheapest %}
    {% endif %}

    <div class="product-price-info text-center">
        {% block component_product_box_price %}
                <div class="product-price-wrapper">
                    {% set price = real %}
                    {% set isListPrice = price and price.listPrice and price.listPrice.percentage > 0 %}
                    {% set isRegulationPrice = price and price.regulationPrice != null %}
                    
                    {% if displayFrom or (displayParent and displayFromVariants) %}
                        {{ "listing.listingTextFrom"|trans|sw_sanitize }}
                    {% endif %}

                    {# Enhanced pricing display - v3.0.0 improvement - Prominent but balanced #}
                    <span class="product-price fw-bold{% if isListPrice and not displayFrom and not displayFromVariants %} with-list-price{% endif %}">
                        {% if price and price.unitPrice %}
                            {{ price.unitPrice|currency }}{{ "general.star"|trans|sw_sanitize }}

                        {% if isListPrice and not displayFrom and not displayFromVariants %}
                            {% set afterListPriceSnippetExists = "listing.afterListPrice"|trans|length > 0 %}
                            {% set beforeListPriceSnippetExists = "listing.beforeListPrice"|trans|length > 0 %}
                            {% set hideStrikeTrough = beforeListPriceSnippetExists or afterListPriceSnippetExists %}

                            <span class="list-price{% if hideStrikeTrough %} list-price-no-line-through{% endif %}">
                                {% if beforeListPriceSnippetExists %}{{ "listing.beforeListPrice"|trans|trim|sw_sanitize }}{% endif %}
                                <br>
                                <span class="list-price-price">{{ price.listPrice.price|currency }}{{ "general.star"|trans|sw_sanitize }}</span>
                                {% if afterListPriceSnippetExists %}{{ "listing.afterListPrice"|trans|trim|sw_sanitize }}{% endif %}
                                <span class="list-price-percentage">{{ "detail.listPricePercentage"|trans({'%price%': price.listPrice.percentage })|sw_sanitize }}</span>
                            </span>
                        {% endif %}
                        {% endif %}
                    </span>
                    
                    {% if isRegulationPrice %}
                        <br>
                        <span class="product-price with-regulation-price">
                            {% if isListPrice %}<br>{% endif %}
                            <span class="regulation-price">{{ "general.listPricePreviously"|trans({'%price%': price.regulationPrice.price|currency }) }}{{ "general.star"|trans|sw_sanitize }}</span>
                        </span>
                        <br>
                    {% endif %}
                    
                    {% if cheapest.unitPrice != real.unitPrice and cheapest.variantId != product.id %}
                        <div class="product-cheapest-price{% if isListPrice and isRegulationPrice and not displayFrom and not displayFromVariants %} with-list-price{% endif %}{% if isRegulationPrice and not displayFrom and displayFromVariants %} with-regulation-price{% endif %}{% if displayFrom and isRegulationPrice %} with-from-price{% endif %}">
                            <div>{{ "listing.cheapestPriceLabel"|trans|sw_sanitize }}<span class="product-cheapest-price-price"> {{ cheapest.unitPrice|currency }}{{ "general.star"|trans|sw_sanitize }}</span></div>
                        </div>
                    {% endif %}
                </div>
            {% endblock %}

            {% block component_product_box_price_unit %}
                {% if referencePrice and (referencePrice.unitName or referencePrice.price) %}
                    <p class="product-price-unit small">
                        {% block component_product_box_price_purchase_unit %}
                            {% if referencePrice.unitName %}
                                <span class="product-unit-label">
                                    {{ "listing.boxUnitLabel"|trans|sw_sanitize }}
                                </span>
                                <span class="price-unit-content">
                                    {{ referencePrice.purchaseUnit }} {{ referencePrice.unitName }}
                                </span>
                            {% endif %}
                        {% endblock %}

                        {% block component_product_box_price_reference_unit %}
                            {% if referencePrice.price %}
                                <span class="price-unit-reference">
                                    ({{ referencePrice.price|currency }}{{ "general.star"|trans|sw_sanitize }} / {{ referencePrice.referenceUnit }} {{ referencePrice.unitName }})
                                </span>
                            {% endif %}
                        {% endblock %}
                    </p>
                {% endif %}
            {% endblock %}
        </div>

    {# v3.0.0 Enhancement - Tax Information stays with price #}
    {% block page_product_detail_tax %}
        <div class="tax-section mb-2">
            {% if product.tax and product.tax.taxRate %}
                <div class="product-detail-tax-container text-center">
                    {% if context.taxState == "gross" %}
                        {% set taxText = "VoltimaxTheme.listing.product.grossTaxInformation"|trans({'%product.taxRate%':product.tax.taxRate}) |sw_sanitize  %}
                    {% else %}
                        {% set taxText = "VoltimaxTheme.listing.product.netTaxInformation"|trans({'%product.taxRate%':product.tax.taxRate}) |sw_sanitize %}
                    {% endif %}

                    <p class="product-detail-tax">
                        {% block page_product_detail_tax_link %}
                            <a class="product-detail-tax-link link-primary text-decoration-underline small"
                               href="{{ path('frontend.cms.page',{ id: config('core.basicInformation.shippingPaymentInfoPage') }) }}"
                               title="{{ taxText }}"
                               {{ dataBsToggleAttr }}="modal"
                               data-url="{{ path('frontend.cms.page',{ id: config('core.basicInformation.shippingPaymentInfoPage') }) }}">
                                {{ taxText }}
                            </a>
                        {% endblock %}
                    </p>
                </div>
            {% endif %}
        </div>
    {% endblock %}

    {# Delivery & Stock Information will be rendered separately #}
    {% block component_delivery_information %}
    {% endblock %}

    {# Stock information block now empty - moved above #}
    {% block battron_component_product_box_stock_info %}
    {% endblock %}
{% endblock %}